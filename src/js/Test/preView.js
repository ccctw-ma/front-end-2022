const dayjs = require('dayjs')


const tree = {
    "_id": "training_project",
    "_rev": "71-7e2157c4b5a9c0169e900d8268750537",
    "title": "训练计划结构树",
    "children": [
        {
            "_id": "cd9cf9f1382984a24a142611fc5eca4bb",
            "title": "大周期测试1",
            "beginTime": "2021-12-31T16:00:00.000Z",
            "endTime": "2022-06-29T16:00:00.000Z",
            "members": [],
            "isApplied": false,
            "hasAppliedTo": "",
            "children": [
                {
                    "_id": "cd9cf9f1382984a24a142611fc5eca4bb_c246126025ece44049dbcf107dea9af7f",
                    "title": "新中周期",
                    "beginTime": "2021-12-31T16:00:00.000Z",
                    "endTime": "2022-01-30T16:00:00.000Z",
                    "children": [
                        {
                            "_id": "cd9cf9f1382984a24a142611fc5eca4bb_c246126025ece44049dbcf107dea9af7f_cb2d313d3d52549569bcb7143335e6984",
                            "title": "跳跃训练",
                            "beginTime": "2021-12-31T16:00:00.000Z",
                            "endTime": "2022-01-14T16:00:00.000Z",
                            "match": {
                                "title": "",
                                "backgroundColor": ""
                            },
                            "externalTraining": {
                                "title": "",
                                "backgroundColor": ""
                            },
                            "children": [
                                {
                                    "_id": "c7bbb8891243546ba8c8388f58b730bb8",
                                    "contents": [
                                        {
                                            "title": "Vertimax栏架跳跃SSC222",
                                            "frequency": "五次",
                                            "rest": "10",
                                            "representative": "1",
                                            "load": "100",
                                            "trainTarget": "explosiveness",
                                            "rhythmE": "1",
                                            "rhythmP": "2",
                                            "rhythmC": "1",
                                            "remarks": "你好明天",
                                            "useElasticBand": false,
                                            "useSource": true,
                                            "sourceType": "power",
                                            "sourceId": "6ddfa157fbc846e49a23089cef1d0aa3",
                                            "_id": "cd4e3bd7928df45a4aa86ffa93a891c77"
                                        }
                                    ],
                                    "time": "2022-01-12T16:00:00.000Z"
                                },
                                {
                                    "_id": "cc4ec74fbd4d0423b91293a3d20015ddb",
                                    "contents": [],
                                    "time": "2022-01-13T16:00:00.000Z"
                                },
                                {
                                    "_id": "cb2483ca7dcf24cfe85625a8bdae6c9ba",
                                    "contents": [],
                                    "time": "2022-01-14T16:00:00.000Z"
                                }
                            ]
                        },
                        {
                            "_id": "cd9cf9f1382984a24a142611fc5eca4bb_c246126025ece44049dbcf107dea9af7f_ccdfc700fb86849c694610f4aac3db276",
                            "title": "新小周期",
                            "beginTime": "2022-01-15T16:00:00.000Z",
                            "endTime": "2022-01-16T16:00:00.000Z",
                            "match": {
                                "title": "",
                                "backgroundColor": ""
                            },
                            "externalTraining": {
                                "title": "",
                                "backgroundColor": ""
                            },
                            "children": [
                                {
                                    "_id": "c0d0ce318257f4b7b9742b6184a68dabf",
                                    "time": "2022-01-15T16:00:00.000Z",
                                    "contents": [
                                        {
                                            "title": "三点式加速（应用）",
                                            "frequency": "",
                                            "rest": "",
                                            "representative": "",
                                            "load": "",
                                            "trainTarget": "",
                                            "rhythmE": "",
                                            "rhythmP": "",
                                            "rhythmC": "",
                                            "remarks": "",
                                            "useElasticBand": false,
                                            "useSource": true,
                                            "sourceType": "power",
                                            "sourceId": "65cd6a77316a4d9797318f61b73d66d5",
                                            "_id": "c6fd48e895dc0473f8db8086f4e1b8823"
                                        }
                                    ]
                                },
                                {
                                    "_id": "cc00d0f558e7342c58dccf928984dee9f",
                                    "time": "2022-01-16T16:00:00.000Z",
                                    "contents": []
                                }
                            ]
                        }
                    ]
                },
                {
                    "_id": "cd9cf9f1382984a24a142611fc5eca4bb_c2943859c0f0945daadcb69be67eea68e",
                    "title": "新中周期",
                    "beginTime": "2022-01-31T16:00:00.000Z",
                    "endTime": "2022-02-27T16:00:00.000Z",
                    "children": [
                        {
                            "_id": "cd9cf9f1382984a24a142611fc5eca4bb_c2943859c0f0945daadcb69be67eea68e_c689a119c511849089affc1440cc8623c",
                            "title": "新小周期",
                            "beginTime": "2022-01-31T16:00:00.000Z",
                            "endTime": "2022-02-04T16:00:00.000Z",
                            "match": {
                                "title": "",
                                "backgroundColor": ""
                            },
                            "externalTraining": {
                                "title": "",
                                "backgroundColor": ""
                            },
                            "children": [
                                {
                                    "_id": "cb21503bda1c64c4b97164a920f04d769",
                                    "time": "2022-01-31T16:00:00.000Z",
                                    "contents": [
                                        {
                                            "title": "交叉步变向（抗阻）",
                                            "frequency": "",
                                            "rest": "",
                                            "representative": "",
                                            "load": "",
                                            "trainTarget": "",
                                            "rhythmE": "",
                                            "rhythmP": "",
                                            "rhythmC": "",
                                            "remarks": "",
                                            "useElasticBand": false,
                                            "useSource": true,
                                            "sourceType": "strength",
                                            "sourceId": "b556b9ee7de14be8a478ae77a91e53ab",
                                            "_id": "cf597c2c716bd42baa88f930298062d90"
                                        }
                                    ]
                                },
                                {
                                    "_id": "c7e65145337364a3fb11b5f370a81534f",
                                    "time": "2022-02-01T16:00:00.000Z",
                                    "contents": []
                                },
                                {
                                    "_id": "c9f827d69e3614686983678cfe2c8981c",
                                    "time": "2022-02-02T16:00:00.000Z",
                                    "contents": []
                                },
                                {
                                    "_id": "c3ff2e4b7ac7a427f96a5a82485a35e76",
                                    "time": "2022-02-03T16:00:00.000Z",
                                    "contents": []
                                },
                                {
                                    "_id": "c5219d683e3454f54a579c99e6fdd2375",
                                    "time": "2022-02-04T16:00:00.000Z",
                                    "contents": []
                                }
                            ]
                        }
                    ]
                },
                {
                    "_id": "cd9cf9f1382984a24a142611fc5eca4bb_c0b851e2c505e4672af6bde853bd2e826",
                    "title": "新中周期",
                    "beginTime": "2022-02-28T16:00:00.000Z",
                    "endTime": "2022-03-30T16:00:00.000Z",
                    "children": [
                        {
                            "_id": "cd9cf9f1382984a24a142611fc5eca4bb_c0b851e2c505e4672af6bde853bd2e826_cb18c06121591400ab51135732c95bd3c",
                            "title": "新小周期",
                            "beginTime": "2022-02-28T16:00:00.000Z",
                            "endTime": "2022-03-04T16:00:00.000Z",
                            "match": {
                                "title": "",
                                "backgroundColor": ""
                            },
                            "externalTraining": {
                                "title": "",
                                "backgroundColor": ""
                            },
                            "children": [
                                {
                                    "_id": "c75651df627704738a046ac7fc8de4819",
                                    "time": "2022-02-28T16:00:00.000Z",
                                    "contents": [
                                        {
                                            "title": "Vertimax剪步交叉蹲跳稳定反应",
                                            "frequency": "",
                                            "rest": "",
                                            "representative": "",
                                            "load": "",
                                            "trainTarget": "",
                                            "rhythmE": "",
                                            "rhythmP": "",
                                            "rhythmC": "",
                                            "remarks": "",
                                            "useElasticBand": false,
                                            "useSource": true,
                                            "sourceType": "strength",
                                            "sourceId": "a6cdff7d15ea48658085cdac160bd922",
                                            "_id": "cf48a49f569574d98a52f4c1e49027bcb"
                                        }
                                    ]
                                },
                                {
                                    "_id": "cb281d676c0124311b57c03984333c835",
                                    "time": "2022-03-01T16:00:00.000Z",
                                    "contents": []
                                },
                                {
                                    "_id": "c681b5449316045278c7a085029c56e2a",
                                    "time": "2022-03-02T16:00:00.000Z",
                                    "contents": []
                                },
                                {
                                    "_id": "c54694853b08b4bf5a466f60da033b195",
                                    "time": "2022-03-03T16:00:00.000Z",
                                    "contents": []
                                },
                                {
                                    "_id": "c4ede1194a2c0450c9a03ccf705df2355",
                                    "time": "2022-03-04T16:00:00.000Z",
                                    "contents": []
                                }
                            ]
                        }
                    ]
                }
            ]
        }
    ]
}



const component = {
    "_id": "c72887cebfe6e4bf98e16534c24fc1fcb",
    "title": "大周期测试1",
    "beginTime": "2021-12-31T16:00:00.000Z",
    "endTime": "2022-06-29T16:00:00.000Z",
    "members": [],
    "isApplied": false,
    "hasAppliedTo": "",
    "children": [
        {
            "_id": "c72887cebfe6e4bf98e16534c24fc1fcb_c6890e1ca05594125a9398d01ee28e452",
            "title": "中周期1",
            "beginTime": "2021-12-31T16:00:00.000Z",
            "endTime": "2022-02-27T16:00:00.000Z",
            "children": [
                {
                    "_id": "c72887cebfe6e4bf98e16534c24fc1fcb_c6890e1ca05594125a9398d01ee28e452_cae9b82d2a6c24d25b34eaedfe0b73e82",
                    "title": "跳跃训练",
                    "beginTime": "2021-12-31T16:00:00.000Z",
                    "endTime": "2022-01-06T16:00:00.000Z",
                    "children": [
                        {
                            "_id": "c14175fbb4a0e47b4bba26b536091e19f",
                            "contents": [
                                {
                                    "title": "后撤开放步过度加速扶墙 2（技术）",
                                    "frequency": "",
                                    "rest": "",
                                    "representative": "",
                                    "load": "",
                                    "trainTarget": "",
                                    "rhythmE": "",
                                    "rhythmP": "",
                                    "rhythmC": "",
                                    "remarks": "",
                                    "useElasticBand": false,
                                    "useSource": true,
                                    "sourceType": "power",
                                    "sourceId": "1d717bd5b2ca4577b6058eb3ec28baaa",
                                    "_id": "ccaf84f50c44e4775b591e2735193ed31"
                                }
                            ],
                            "time": "2022-01-30T16:00:00.000Z"
                        },
                        {
                            "_id": "cf84e0fd54710474ebb29a047808242ab",
                            "contents": [],
                            "time": "2022-01-31T16:00:00.000Z"
                        },
                        {
                            "_id": "c2f326e921c4c46b4b5c0419afd9d2a8b",
                            "contents": [],
                            "time": "2022-02-01T16:00:00.000Z"
                        },
                        {
                            "_id": "cc6a09aa9801c4065808241aaee91dea8",
                            "time": "2022-02-02T16:00:00.000Z",
                            "contents": []
                        },
                        {
                            "_id": "c8a50f60642da4b169b2bb54ed9dcb001",
                            "time": "2022-02-03T16:00:00.000Z",
                            "contents": []
                        },
                        {
                            "_id": "c12d41698a78e41fcbde99f5f8d7d0b47",
                            "time": "2022-02-04T16:00:00.000Z",
                            "contents": []
                        },
                        {
                            "_id": "c1d2fc87540674976bbd6a21fbbb7741e",
                            "time": "2022-02-05T16:00:00.000Z",
                            "contents": []
                        }
                    ]
                },
                {
                    "_id": "c72887cebfe6e4bf98e16534c24fc1fcb_c6890e1ca05594125a9398d01ee28e452_c2edf3c5baeed46058d5498193c00568a",
                    "title": "新小周期",
                    "beginTime": "2022-01-07T16:00:00.000Z",
                    "endTime": "2022-01-13T16:00:00.000Z",
                    "children": [
                        {
                            "_id": "cf86fbdb1c8d745f4829a14fcb5481e95",
                            "time": "2022-02-02T16:00:00.000Z",
                            "contents": []
                        },
                        {
                            "_id": "ccb7b52871d8244be9e2f0120656e2f29",
                            "time": "2022-02-03T16:00:00.000Z",
                            "contents": []
                        },
                        {
                            "_id": "ca4cf7747bdae48f7af16c02bd9b7bb46",
                            "time": "2022-02-04T16:00:00.000Z",
                            "contents": []
                        },
                        {
                            "_id": "c7823248df69344768f985c96d68b723d",
                            "time": "2022-02-05T16:00:00.000Z",
                            "contents": []
                        },
                        {
                            "_id": "c6b9b80ede0544130a0fda7995e9e8875",
                            "time": "2022-02-06T16:00:00.000Z",
                            "contents": []
                        },
                        {
                            "_id": "c57df007d0cd1453b8b27a206e15c9cfd",
                            "time": "2022-02-07T16:00:00.000Z",
                            "contents": []
                        },
                        {
                            "_id": "c86f467e4048740b1a497f6f9277aa6c7",
                            "time": "2022-02-08T16:00:00.000Z",
                            "contents": []
                        }
                    ]
                },
                {
                    "_id": "c72887cebfe6e4bf98e16534c24fc1fcb_c6890e1ca05594125a9398d01ee28e452_c1a6992449909400eb5d397ff01ac0584",
                    "title": "蹲跳",
                    "beginTime": "2022-01-14T16:00:00.000Z",
                    "endTime": "2022-01-20T16:00:00.000Z",
                    "children": [
                        {
                            "_id": "c0f16f53786fe4a068971c0177531c41e",
                            "contents": [
                                {
                                    "title": "Vertimax剪步交叉蹲跳连续反应",
                                    "frequency": "",
                                    "rest": "",
                                    "representative": "",
                                    "load": "",
                                    "trainTarget": "",
                                    "rhythmE": "",
                                    "rhythmP": "",
                                    "rhythmC": "",
                                    "remarks": "",
                                    "useElasticBand": false,
                                    "useSource": true,
                                    "sourceType": "strength",
                                    "sourceId": "5265a43879fd4dfba8fff980dcfe2311",
                                    "_id": "cb31470cdd7504817a155b148cf8672a6"
                                }
                            ],
                            "time": "2022-02-04T16:00:00.000Z"
                        },
                        {
                            "_id": "c06fee3521d3b4bff86747164716c8bee",
                            "contents": [],
                            "time": "2022-02-05T16:00:00.000Z"
                        },
                        {
                            "_id": "c18c6684b9c2940ba9f5d5136b3d425f5",
                            "contents": [],
                            "time": "2022-02-06T16:00:00.000Z"
                        },
                        {
                            "_id": "cfb62462c8c5d4260a51c4ef8c5eca90f",
                            "contents": [],
                            "time": "2022-02-07T16:00:00.000Z"
                        },
                        {
                            "_id": "c73e00d02093a49808e001b1474b85156",
                            "time": "2022-02-08T16:00:00.000Z",
                            "contents": []
                        },
                        {
                            "_id": "ce98e2efd45e540109d15af1287b1072c",
                            "time": "2022-02-09T16:00:00.000Z",
                            "contents": []
                        },
                        {
                            "_id": "c84e6403bf2c548d69ad9c6bf4608974b",
                            "time": "2022-02-10T16:00:00.000Z",
                            "contents": []
                        }
                    ]
                }
            ]
        }
    ]
}


const getParent = (node) => {
    let levels = node._id.split('_');
    let tar = {};
    if (levels.length === 1) {
        tar._id = 'training_project';
    } else if (levels.length === 2) {
        tar._id = levels[0];
    } else {
        tar._id = levels[0] + '_' + levels[1];
    }
    return getNode(tar);
}

const getNode = node => {
    let queue = [tree];
    while (queue.length) {
        for (let i = 0; i < queue.length; i++) {
            let temp = queue.shift();
            if (temp._id === node._id) {
                return temp;
            } else if (temp._id.split("_").length !== 3) {
                temp.children.forEach(c => queue.push(c))
            }
        }
    }
    return null;
}

const getLevel = _id => _id === 'training_project' ? 0 : _id.split('_').length;
const getSurplus = component => {
    const level = getLevel(component._id);
    if (level >= 2) {
        component = getParent(component);
    }
    let end = component.endTime;
    let curEnd = component.children.length === 0 ? component.beginTime : component.children[component.children.length - 1].endTime
    return dayjs(end).diff(dayjs(curEnd), 'day');
}

//左侧的标签数据
let labels = [
    "月份",
    "大周期",
    "中周期",
    "小周期",
    "比赛",
    "外训",
    "组数",
    "次数",
    "恢复时间",
]
labels = labels.map(label => {
    return {type: "label", value: label, span: 1}
})

let months = [
    "一月",
    "二月",
    "三月",
    "四月",
    "五月",
    "六月",
    "七月",
    "八月",
    "九月",
    "十月",
    "十一月",
    "十二月",
]

let big = component


const fn = big => {
    // 确定每个月占据的格数
    let arr = new Array(12).fill(0)
    let beginMonth = dayjs(big.beginTime).month()
    let bigCycle = [], mediumCycle = [], smallCycle = []
// 其他信息
    let infos = [[], [], [], [], []];

//将大周期开始前的格子设为空
    for (let i = 0; i < beginMonth; i++) {
        bigCycle.push({type: "empty", value: "", span: 1})
        mediumCycle.push({type: "empty", value: "", span: 1})
        smallCycle.push({type: "empty", value: "", span: 1})
        infos.forEach(row => row.push({type: "empty", value: "", span: 1}))
    }
//大周期的长度
    let bigSpan = 0;
    for (let i = 0; i < big.children.length; i++) {
        //处理每个中周期
        let medium = big.children[i]
        //中周期的长度
        let mediumSpan = 0
        for (let j = 0; j < medium.children.length; j++) {
            //处理每个小周期
            let small = medium.children[j]
            //每个小周期格子填入小周期的信息
            smallCycle.push({type: "cycle", value: small, span: 1})
            infos.forEach(row => row.push({type: "cycle", value: small, span: 1}))
            //小周期开始时间占据的月份格子长度+1
            arr[dayjs(small.beginTime).month()]++
            mediumSpan++
        }
        //该中周期有剩余时间
        if (getSurplus(medium) !== 0) {
            let surplusBeginTime = dayjs(medium.children[medium.children.length - 1].endTime).add(1, 'day');
            let nextMediumCycleBeginTime = dayjs(medium.endTime).add(1, 'day');
            arr[surplusBeginTime.month()]++
            mediumSpan++
            smallCycle.push({type: "surplus", value: "余量", span: 1})
            infos.forEach(row => row.push({type: "empty", value: '', span: 1}))
            for (let t = surplusBeginTime.month() + 1; t < nextMediumCycleBeginTime.month(); t++) {
                arr[t]++
                mediumSpan++
                smallCycle.push({type: "surplus", value: "余量", span: 1})
                infos.forEach(row => row.push({type: "empty", value: '', span: 1}))
            }
        }
        //没有剩余时间的话，中周期长度就等于小周期的个数，有余量的话就加上余量的个数
        mediumCycle.push({type: "cycle", value: medium, span: mediumSpan});
        bigSpan += mediumSpan;
    }

//该大周期有剩余时间
    if (getSurplus(big) !== 0) {
        let surplusBeginTime = dayjs(big.children[big.children.length - 1].endTime).add(1, 'day');
        let nextBigCycleBeginTime = dayjs(big.endTime).add(1, 'day');
        arr[surplusBeginTime.month()]++
        bigSpan++
        mediumCycle.push({type: "surplus", value: "余量", span: 1})
        smallCycle.push({type: "empty", value: "", span: 1})
        infos.forEach(row => row.push({type: "empty", value: '', span: 1}))
        for (let t = surplusBeginTime.month() + 1; t < nextBigCycleBeginTime.month(); t++) {
            arr[t]++
            bigSpan++
            mediumCycle.push({type: "surplus", value: "余量", span: 1})
            smallCycle.push({type: "empty", value: "", span: 1})
            infos.forEach(row => row.push({type: "empty", value: '', span: 1}))
        }
    }

    bigCycle.push({type: "cycle", value: big, span: bigSpan})

    arr = arr.map(n => (n === 0 ? 1 : n))
    let sum = arr.reduce((pre, cur) => pre + cur, 0)
//处理剩余时间
    for (let i = dayjs(big.endTime).add(1, 'day').month(); i < 12; i++) {
        bigCycle.push({type: "empty", value: "", span: 1})
        mediumCycle.push({type: "empty", value: "", span: 1})
        smallCycle.push({type: "empty", value: "", span: 1})
        infos.forEach(row => row.push({type: "empty", value: "", span: 1}))
    }

    console.log("TranPlanPreviewModal", arr, sum)

//处理每个月份的长度
    months = months.map((month, index) => {
        return {type: "month", value: month, span: arr[index]}
    })


    let data = labels.map(label => [label]);
    data[0].push(...months)
    data[1].push(...bigCycle)
    data[2].push(...mediumCycle)
    data[3].push(...smallCycle)
    for (let i = 4; i < 9; i++) {
        data[i].push(...infos[i - 4])
    }
    return data
}


console.log('TranPlanPreviewModal---------------------->', fn(big))
